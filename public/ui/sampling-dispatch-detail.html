<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é‡‡æ ·ä»»åŠ¡è¯¦æƒ… - LIMS-XWç³»ç»Ÿ</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC',
          'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
        min-height: 100vh;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
      }

      /* é¢åŒ…å±‘å¯¼èˆª */
      .breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 24px;
        font-size: 14px;
        color: #6b7280;
      }

      .breadcrumb a {
        color: #3b82f6;
        text-decoration: none;
        transition: color 0.3s;
      }

      .breadcrumb a:hover {
        color: #2563eb;
        text-decoration: underline;
      }

      .breadcrumb-separator {
        color: #9ca3af;
      }

      /* ä¸»è¦å†…å®¹åŒº */
      .content-wrapper {
        display: grid;
        grid-template-columns: 60% 40%;
        gap: 24px;
        align-items: start;
      }

      /* å·¦ä¾§ä¿¡æ¯å±•ç¤ºåŒº */
      .info-section {
        background: white;
        border-radius: 16px;
        box-shadow:
          0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        overflow: hidden;
      }

      /* é¡¹ç›®ç¼–å·åŒºåŸŸ */
      .project-header {
        padding: 24px;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        position: relative;
        overflow: hidden;
      }

      .project-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 50%;
        height: 200%;
        background: rgba(255, 255, 255, 0.05);
        transform: rotate(35deg);
      }

      .project-number {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 16px;
        position: relative;
        z-index: 1;
      }

      .status-badge {
        padding: 6px 16px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        backdrop-filter: blur(10px);
      }

      .urgent-badge {
        background: #ef4444;
        color: white;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .project-meta {
        display: flex;
        gap: 24px;
        font-size: 14px;
        opacity: 0.9;
        position: relative;
        z-index: 1;
      }

      /* ä¿¡æ¯å¡ç‰‡ */
      .info-card {
        padding: 24px;
        border-bottom: 1px solid #e5e7eb;
      }

      .info-card:last-child {
        border-bottom: none;
      }

      .card-title {
        font-size: 16px;
        font-weight: 600;
        color: #1a202c;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .card-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border-radius: 6px;
        font-size: 14px;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }

      .info-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .info-label {
        font-size: 13px;
        color: #6b7280;
        font-weight: 500;
      }

      .info-value {
        font-size: 15px;
        color: #1a202c;
        font-weight: 600;
      }

      /* æ£€æµ‹å†…å®¹å¡ç‰‡ */
      .test-content-card {
        background: #f9fafb;
        border-radius: 12px;
        padding: 16px;
        margin-top: 16px;
      }

      .test-type {
        display: inline-block;
        background: #10b981;
        color: white;
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 12px;
      }

      .test-items {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
      }

      .test-item {
        background: white;
        padding: 6px 12px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        font-size: 14px;
        color: #4b5563;
      }

      /* å³ä¾§åˆ†æ´¾è¡¨å•åŒº */
      .dispatch-section {
        background: white;
        border-radius: 16px;
        box-shadow:
          0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        overflow: hidden;
        position: sticky;
        top: 24px;
      }

      .dispatch-header {
        padding: 20px 24px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
      }

      .dispatch-title {
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .dispatch-body {
        padding: 24px;
      }

      /* è¡¨å•æ ·å¼ */
      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #374151;
        font-size: 14px;
      }

      .form-label .required {
        color: #ef4444;
      }

      .form-control {
        width: 100%;
        padding: 10px 14px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 14px;
        transition: all 0.3s;
        background: white;
      }

      .form-control:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      textarea.form-control {
        resize: vertical;
        min-height: 100px;
      }

      /* äººå‘˜é€‰æ‹© */
      .staff-select-container {
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        padding: 12px;
        background: #f9fafb;
        max-height: 250px;
        overflow-y: auto;
      }

      .staff-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 8px;
      }

      .staff-option:last-child {
        margin-bottom: 0;
      }

      .staff-option:hover {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.05);
      }

      .staff-option.selected {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.1);
      }

      .staff-checkbox {
        width: 20px;
        height: 20px;
        accent-color: #3b82f6;
      }

      .staff-info {
        flex: 1;
      }

      .staff-name {
        font-weight: 600;
        color: #1a202c;
        margin-bottom: 2px;
      }

      .staff-status {
        font-size: 12px;
        color: #6b7280;
      }

      .staff-tasks {
        padding: 4px 8px;
        background: #f3f4f6;
        border-radius: 6px;
        font-size: 12px;
        color: #4b5563;
        font-weight: 600;
      }

      /* æ“ä½œæŒ‰é’® */
      .form-actions {
        display: flex;
        gap: 12px;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
      }

      .btn {
        flex: 1;
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        transform: translateY(-2px);
        box-shadow: 0 10px 20px -5px rgba(59, 130, 246, 0.3);
      }

      .btn-secondary {
        background: #f3f4f6;
        color: #4b5563;
      }

      .btn-secondary:hover {
        background: #e5e7eb;
        transform: translateX(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      /* ç‰¹æ®Šè¦æ±‚è¯´æ˜ */
      .special-notice {
        background: #fef3c7;
        border: 1px solid #fcd34d;
        border-radius: 10px;
        padding: 12px;
        margin-top: 12px;
      }

      .special-notice-title {
        font-weight: 600;
        color: #92400e;
        margin-bottom: 4px;
        font-size: 14px;
      }

      .special-notice-content {
        color: #78350f;
        font-size: 14px;
        line-height: 1.5;
      }

      /* æˆåŠŸæç¤º */
      .success-toast {
        position: fixed;
        top: 24px;
        right: 24px;
        background: #10b981;
        color: white;
        padding: 16px 24px;
        border-radius: 10px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
        display: none;
        align-items: center;
        gap: 12px;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
      }

      .success-toast.show {
        display: flex;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 1024px) {
        .content-wrapper {
          grid-template-columns: 1fr;
        }

        .dispatch-section {
          position: static;
        }
      }

      @media (max-width: 768px) {
        .container {
          padding: 16px;
        }

        .project-number {
          font-size: 24px;
        }

        .info-grid {
          grid-template-columns: 1fr;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .form-actions {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- ç»Ÿä¸€å¯¼èˆªæ ç»„ä»¶ -->
    <script src="navigation.js"></script>

    <div class="container">
      <!-- é¢åŒ…å±‘å¯¼èˆª -->
      <div class="breadcrumb">
        <a href="sampling-dispatch.html" id="breadcrumbLink">é‡‡æ ·è°ƒåº¦å·¥ä½œå°</a>
        <span class="breadcrumb-separator">â€º</span>
        <span>ä»»åŠ¡è¯¦æƒ…</span>
      </div>

      <!-- ä¸»è¦å†…å®¹åŒº -->
      <div class="content-wrapper">
        <!-- å·¦ä¾§ä¿¡æ¯å±•ç¤ºåŒº -->
        <div class="info-section">
          <!-- é¡¹ç›®ç¼–å·åŒºåŸŸ -->
          <div class="project-header">
            <div class="project-number">
              <span id="projectNumber">XW2024030001</span>
              <span class="status-badge">å¾…åˆ†æ´¾</span>
              <span class="urgent-badge" id="urgentBadge" style="display: none"
                >åŠ æ€¥</span
              >
            </div>
            <div class="project-meta">
              <span
                >åˆ›å»ºæ—¶é—´: <span id="createTime">2024-03-15 09:00</span></span
              >
              <span>æˆªæ­¢æ—¶é—´: <span id="deadline">2024-03-18 18:00</span></span>
            </div>
          </div>

          <!-- å®¢æˆ·åŸºæœ¬ä¿¡æ¯ -->
          <div class="info-card">
            <div class="card-title">
              <div class="card-icon">ğŸ¢</div>
              <span>å®¢æˆ·åŸºæœ¬ä¿¡æ¯</span>
            </div>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">å®¢æˆ·åç§°</span>
                <span class="info-value" id="customerName"
                  >æ·±åœ³å¸‚æŸæŸè‡ªæ¥æ°´å…¬å¸</span
                >
              </div>
              <div class="info-item">
                <span class="info-label">è”ç³»äºº</span>
                <span class="info-value" id="contactPerson">å¼ ç»ç†</span>
              </div>
              <div class="info-item">
                <span class="info-label">è”ç³»ç”µè¯</span>
                <span class="info-value" id="contactPhone">138-1234-5678</span>
              </div>
              <div class="info-item">
                <span class="info-label">å—æ£€å•ä½</span>
                <span class="info-value" id="inspectionUnit"
                  >æ·±åœ³å¸‚æŸæŸè‡ªæ¥æ°´å…¬å¸å‡€æ°´å‚</span
                >
              </div>
            </div>
            <div class="info-item" style="margin-top: 16px">
              <span class="info-label">é‡‡æ ·åœ°å€</span>
              <span class="info-value" id="samplingAddress"
                >æ·±åœ³å¸‚å—å±±åŒºç§‘æŠ€å›­å—è·¯123å·</span
              >
            </div>
          </div>

          <!-- è®¢å•æ£€æµ‹å†…å®¹ -->
          <div class="info-card">
            <div class="card-title">
              <div class="card-icon">ğŸ§ª</div>
              <span>è®¢å•æ£€æµ‹å†…å®¹</span>
            </div>
            <div class="test-content-card">
              <div class="test-type" id="testType">50325-2020</div>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">æ£€æµ‹å†…å®¹</span>
                  <span class="info-value" id="testContent"
                    >å®¤å†…ç©ºæ°”è´¨é‡æ£€æµ‹</span
                  >
                </div>
                <div class="info-item">
                  <span class="info-label">é‡‡æ ·ç‚¹æ•°</span>
                  <span class="info-value" id="samplingPoints">8ä¸ª</span>
                </div>
              </div>
              <div class="test-items">
                <div class="test-item">ç”²é†›</div>
                <div class="test-item">è‹¯</div>
                <div class="test-item">ç”²è‹¯</div>
                <div class="test-item">äºŒç”²è‹¯</div>
                <div class="test-item">TVOC</div>
              </div>
            </div>

            <div
              class="special-notice"
              id="specialRequirements"
              style="display: none"
            >
              <div class="special-notice-title">ç‰¹æ®Šè¦æ±‚è¯´æ˜</div>
              <div
                class="special-notice-content"
                id="specialRequirementsContent"
              >
                è¯·åœ¨ä¸Šåˆ9ç‚¹å‰åˆ°è¾¾ç°åœºï¼Œéœ€è¦å®¢æˆ·ä»£è¡¨å…¨ç¨‹é™ªåŒã€‚
              </div>
            </div>
          </div>
        </div>

        <!-- å³ä¾§åˆ†æ´¾è¡¨å•åŒº -->
        <div class="dispatch-section">
          <div class="dispatch-header">
            <div class="dispatch-title">
              <span>ğŸ“</span>
              <span>ä»»åŠ¡åˆ†æ´¾</span>
            </div>
          </div>
          <div class="dispatch-body">
            <form id="dispatchForm">
              <div class="form-group">
                <label class="form-label">
                  é‡‡æ ·äººå‘˜ <span class="required">*</span>
                </label>
                <div class="staff-select-container" id="staffSelectContainer">
                  <!-- äººå‘˜é€‰é¡¹å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">
                  é‡‡æ ·æ—¥æœŸ <span class="required">*</span>
                </label>
                <input
                  type="date"
                  class="form-control"
                  id="samplingDate"
                  required
                />
              </div>

              <div class="form-group">
                <label class="form-label">
                  é‡‡æ ·æ—¶é—´ <span class="required">*</span>
                </label>
                <div class="form-row">
                  <input
                    type="time"
                    class="form-control"
                    id="startTime"
                    placeholder="å¼€å§‹æ—¶é—´"
                    required
                  />
                  <input
                    type="time"
                    class="form-control"
                    id="endTime"
                    placeholder="ç»“æŸæ—¶é—´"
                    required
                  />
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">å¤‡æ³¨è¯´æ˜</label>
                <textarea
                  class="form-control"
                  id="remarks"
                  placeholder="è¯·è¾“å…¥ç‰¹æ®Šè¦æ±‚æˆ–æ³¨æ„äº‹é¡¹..."
                ></textarea>
              </div>

              <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="backButton">
                  <span>â†</span>
                  <span>è¿”å›å·¥ä½œå°</span>
                </button>
                <button type="submit" class="btn btn-primary">
                  <span>âœ“</span>
                  <span>ç«‹å³åˆ†æ´¾</span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- æˆåŠŸæç¤º -->
    <div class="success-toast" id="successToast">
      <span>âœ“</span>
      <span>åˆ†æ´¾æˆåŠŸï¼æ­£åœ¨è¿”å›åˆ—è¡¨...</span>
    </div>

    <script>
      // å…¨å±€å˜é‡
      let selectedStaff = new Set()
      let taskData = {}

      // æµ‹è¯•æ•°æ®
      const testData = {
        XW2024030001: {
          projectNumber: 'XW2024030001',
          status: 'å¾…åˆ†æ´¾',
          isUrgent: true,
          createTime: '2024-03-15 09:00',
          deadline: '2024-03-18 18:00',
          customerName: 'æ·±åœ³å¸‚æŸæŸè‡ªæ¥æ°´å…¬å¸',
          contactPerson: 'å¼ ç»ç†',
          contactPhone: '138-1234-5678',
          inspectionUnit: 'æ·±åœ³å¸‚æŸæŸè‡ªæ¥æ°´å…¬å¸å‡€æ°´å‚',
          samplingAddress: 'æ·±åœ³å¸‚å—å±±åŒºç§‘æŠ€å›­å—è·¯123å·',
          testType: '50325-2020',
          testContent: 'å®¤å†…ç©ºæ°”è´¨é‡æ£€æµ‹',
          samplingPoints: '8ä¸ª',
          testItems: ['ç”²é†›', 'è‹¯', 'ç”²è‹¯', 'äºŒç”²è‹¯', 'TVOC'],
          specialRequirements: 'è¯·åœ¨ä¸Šåˆ9ç‚¹å‰åˆ°è¾¾ç°åœºï¼Œéœ€è¦å®¢æˆ·ä»£è¡¨å…¨ç¨‹é™ªåŒã€‚'
        },
        XW2024030002: {
          projectNumber: 'XW2024030002',
          status: 'å¾…åˆ†æ´¾',
          isUrgent: false,
          createTime: '2024-03-15 10:30',
          deadline: '2024-03-20 18:00',
          customerName: 'ç¦ç”°åŒºæŸé…’åº—',
          contactPerson: 'ææ€»ç›‘',
          contactPhone: '139-8765-4321',
          inspectionUnit: 'ç¦ç”°åŒºæŸäº”æ˜Ÿçº§é…’åº—',
          samplingAddress: 'æ·±åœ³å¸‚ç¦ç”°åŒºç¦åè·¯88å·',
          testType: 'GB/T 18883',
          testContent: 'å…¬å…±åœºæ‰€å«ç”Ÿæ£€æµ‹',
          samplingPoints: '12ä¸ª',
          testItems: ['ç»†èŒæ€»æ•°', 'çœŸèŒæ€»æ•°', 'PM2.5', 'PM10', 'ç”²é†›', 'CO2'],
          specialRequirements: null
        },
        XW2024030003: {
          projectNumber: 'XW2024030003',
          status: 'å¾…åˆ†æ´¾',
          isUrgent: true,
          createTime: '2024-03-15 11:00',
          deadline: '2024-03-17 12:00',
          customerName: 'ç½—æ¹–åŒºæŸå°åŒºç‰©ä¸š',
          contactPerson: 'ç‹ä¸»ä»»',
          contactPhone: '136-5555-6666',
          inspectionUnit: 'ç½—æ¹–åŒºæŸèŠ±å›­å°åŒº',
          samplingAddress: 'æ·±åœ³å¸‚ç½—æ¹–åŒºä¸œé—¨åŒ—è·¯456å·',
          testType: 'HJ 583-2010',
          testContent: 'ç¯å¢ƒç©ºæ°”è´¨é‡ç›‘æµ‹',
          samplingPoints: '5ä¸ª',
          testItems: ['SO2', 'NO2', 'CO', 'O3', 'PM10', 'PM2.5'],
          specialRequirements:
            'éœ€è¦åœ¨å°åŒºå¤šä¸ªä½ç½®è¿›è¡Œé‡‡æ ·ï¼Œè¯·æå‰ä¸ä¿å®‰å¤„è”ç³»ã€‚'
        }
      }

      // é‡‡æ ·äººå‘˜æ•°æ®
      const staffList = [
        { id: 1, name: 'æé‡‡æ ·', status: 'ç©ºé—²', tasks: 2 },
        { id: 2, name: 'ç‹æŠ€æœ¯', status: 'å·¥ä½œä¸­', tasks: 3 },
        { id: 3, name: 'å¼ å·¥ç¨‹', status: 'ç©ºé—²', tasks: 1 },
        { id: 4, name: 'é™ˆä¸“å‘˜', status: 'ç©ºé—²', tasks: 0 },
        { id: 5, name: 'èµµæŠ€æœ¯', status: 'å·¥ä½œä¸­', tasks: 4 },
        { id: 6, name: 'åˆ˜é‡‡æ ·', status: 'ç©ºé—²', tasks: 2 }
      ]

      // é¡µé¢åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', () => {
        // è®¾ç½®é¡µé¢æ ‡é¢˜
        if (window.limsNav) {
          window.limsNav.setPageTitle('é‡‡æ ·ä»»åŠ¡è¯¦æƒ…')
        } else {
          // å¦‚æœå¯¼èˆªæ æœªåŠ è½½ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
          setTimeout(() => {
            if (window.limsNav) {
              window.limsNav.setPageTitle('é‡‡æ ·ä»»åŠ¡è¯¦æƒ…')
            }
          }, 100)
        }

        // è·å–ä»»åŠ¡ID
        const urlParams = new URLSearchParams(window.location.search)
        const taskId = urlParams.get('taskId') || 'XW2024030001'

        // åŠ è½½ä»»åŠ¡æ•°æ®
        loadTaskData(taskId)

        // åˆå§‹åŒ–äººå‘˜é€‰æ‹©
        initializeStaffSelect()

        // è®¾ç½®é»˜è®¤æ—¥æœŸ
        const today = new Date().toISOString().split('T')[0]
        document.getElementById('samplingDate').value = today

        // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
        document
          .getElementById('dispatchForm')
          .addEventListener('submit', handleSubmit)

        // ç»‘å®šè¿”å›æŒ‰é’®äº‹ä»¶
        const backButton = document.getElementById('backButton')
        if (backButton) {
          backButton.addEventListener('click', e => {
            e.preventDefault()
            e.stopPropagation()
            console.log('Back button clicked')
            goBack()
          })
        }

        // ç»‘å®šé¢åŒ…å±‘é“¾æ¥äº‹ä»¶
        const breadcrumbLink = document.getElementById('breadcrumbLink')
        if (breadcrumbLink) {
          breadcrumbLink.addEventListener('click', e => {
            e.preventDefault()
            e.stopPropagation()
            console.log('Breadcrumb link clicked')
            goBack()
          })
        }

        // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', e => {
          // ESCé”®è¿”å›åˆ—è¡¨ï¼ˆå¦‚æœä¸‹æ‹‰èœå•æœªæ‰“å¼€ï¼‰
          if (e.key === 'Escape') {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ‰“å¼€çš„ä¸‹æ‹‰èœå•
            const hasOpenDropdown = document.querySelector(
              '.user-dropdown.show'
            )
            if (!hasOpenDropdown) {
              goBack()
            }
          }
        })
      })

      // åŠ è½½ä»»åŠ¡æ•°æ®
      function loadTaskData(taskId) {
        // æ ¹æ®ä»»åŠ¡IDå‰ç¼€ç”Ÿæˆå¯¹åº”çš„æµ‹è¯•æ•°æ®
        const taskNumber = parseInt(taskId.slice(-3))
        const testTypes = [
          '50325-2020',
          'GB/T 18883',
          'HJ 583-2010',
          'GB 50325',
          'ISO 16000'
        ]
        const companies = [
          'æ·±åœ³å¸‚æŸæŸè‡ªæ¥æ°´å…¬å¸',
          'ç¦ç”°åŒºæŸé…’åº—',
          'ç½—æ¹–åŒºæŸå°åŒºç‰©ä¸š',
          'å—å±±åŒºæŸåŒ»é™¢',
          'å®å®‰åŒºæŸå·¥å‚'
        ]
        const addresses = [
          'æ·±åœ³å¸‚å—å±±åŒºç§‘æŠ€å›­å—è·¯123å·',
          'æ·±åœ³å¸‚ç¦ç”°åŒºç¦åè·¯88å·',
          'æ·±åœ³å¸‚ç½—æ¹–åŒºä¸œé—¨åŒ—è·¯456å·',
          'æ·±åœ³å¸‚å—å±±åŒºæ·±å—å¤§é“999å·',
          'æ·±åœ³å¸‚å®å®‰åŒºæ–°å®‰è¡—é“'
        ]

        taskData = {
          projectNumber: taskId,
          status: 'å¾…åˆ†æ´¾',
          isUrgent: taskNumber <= 8,
          createTime: `2024-03-${15 - Math.floor(taskNumber / 100)} ${9 + (taskNumber % 12)}:00`,
          deadline: `2024-03-${18 + Math.floor(taskNumber / 50)} 18:00`,
          customerName: companies[taskNumber % 5],
          contactPerson: ['å¼ ç»ç†', 'ææ€»ç›‘', 'ç‹ä¸»ä»»', 'é™ˆæ€»', 'èµµç»ç†'][
            taskNumber % 5
          ],
          contactPhone: `13${8 + (taskNumber % 2)}-${1234 + taskNumber}-${5678 - taskNumber}`,
          inspectionUnit: companies[taskNumber % 5] + 'æ£€æµ‹ç‚¹',
          samplingAddress: addresses[taskNumber % 5],
          testType: testTypes[taskNumber % testTypes.length],
          testContent: 'å®¤å†…ç©ºæ°”è´¨é‡æ£€æµ‹',
          samplingPoints: `${Math.floor(Math.random() * 10) + 5}ä¸ª`,
          testItems: ['ç”²é†›', 'è‹¯', 'ç”²è‹¯', 'äºŒç”²è‹¯', 'TVOC'],
          specialRequirements:
            taskNumber % 3 === 0
              ? 'è¯·åœ¨ä¸Šåˆ9ç‚¹å‰åˆ°è¾¾ç°åœºï¼Œéœ€è¦å®¢æˆ·ä»£è¡¨å…¨ç¨‹é™ªåŒã€‚'
              : null
        }

        // æ›´æ–°é¡µé¢æ˜¾ç¤º
        updatePageDisplay()
      }

      // æ›´æ–°é¡µé¢æ˜¾ç¤º
      function updatePageDisplay() {
        document.getElementById('projectNumber').textContent =
          taskData.projectNumber
        document.getElementById('createTime').textContent = taskData.createTime
        document.getElementById('deadline').textContent = taskData.deadline
        document.getElementById('customerName').textContent =
          taskData.customerName
        document.getElementById('contactPerson').textContent =
          taskData.contactPerson
        document.getElementById('contactPhone').textContent =
          taskData.contactPhone
        document.getElementById('inspectionUnit').textContent =
          taskData.inspectionUnit
        document.getElementById('samplingAddress').textContent =
          taskData.samplingAddress
        document.getElementById('testType').textContent = taskData.testType
        document.getElementById('testContent').textContent =
          taskData.testContent
        document.getElementById('samplingPoints').textContent =
          taskData.samplingPoints

        // æ˜¾ç¤ºåŠ æ€¥æ ‡è¯†
        if (taskData.isUrgent) {
          document.getElementById('urgentBadge').style.display = 'inline-block'
        }

        // æ˜¾ç¤ºç‰¹æ®Šè¦æ±‚
        if (taskData.specialRequirements) {
          document.getElementById('specialRequirements').style.display = 'block'
          document.getElementById('specialRequirementsContent').textContent =
            taskData.specialRequirements
        }

        // æ›´æ–°æ£€æµ‹é¡¹ç›®
        const testItemsContainer = document.querySelector('.test-items')
        testItemsContainer.innerHTML = taskData.testItems
          .map(item => `<div class="test-item">${item}</div>`)
          .join('')
      }

      // åˆå§‹åŒ–äººå‘˜é€‰æ‹©
      function initializeStaffSelect() {
        const container = document.getElementById('staffSelectContainer')

        container.innerHTML = staffList
          .map(
            staff => `
                <div class="staff-option" data-id="${staff.id}">
                    <input type="checkbox" class="staff-checkbox" id="staff-${staff.id}" 
                           onchange="toggleStaff(${staff.id})">
                    <label for="staff-${staff.id}" class="staff-info">
                        <div class="staff-name">${staff.name}</div>
                        <div class="staff-status">çŠ¶æ€: ${staff.status}</div>
                    </label>
                    <div class="staff-tasks">ä»Šæ—¥${staff.tasks}ä¸ªä»»åŠ¡</div>
                </div>
            `
          )
          .join('')
      }

      // åˆ‡æ¢äººå‘˜é€‰æ‹©
      function toggleStaff(id) {
        const option = document.querySelector(`.staff-option[data-id="${id}"]`)
        const checkbox = document.getElementById(`staff-${id}`)

        if (checkbox.checked) {
          selectedStaff.add(id)
          option.classList.add('selected')
        } else {
          selectedStaff.delete(id)
          option.classList.remove('selected')
        }
      }

      // å¤„ç†è¡¨å•æäº¤
      function handleSubmit(e) {
        e.preventDefault()

        // éªŒè¯æ˜¯å¦é€‰æ‹©äº†äººå‘˜
        if (selectedStaff.size === 0) {
          alert('è¯·è‡³å°‘é€‰æ‹©ä¸€åé‡‡æ ·äººå‘˜')
          return
        }

        // è·å–è¡¨å•æ•°æ®
        const formData = {
          taskId: taskData.projectNumber,
          staff: Array.from(selectedStaff),
          date: document.getElementById('samplingDate').value,
          startTime: document.getElementById('startTime').value,
          endTime: document.getElementById('endTime').value,
          remarks: document.getElementById('remarks').value
        }

        // æ˜¾ç¤ºæˆåŠŸæç¤º
        showSuccessToast()

        // å»¶è¿Ÿè¿”å›åˆ—è¡¨
        setTimeout(() => {
          window.location.href = 'sampling-dispatch.html'
        }, 2000)
      }

      // æ˜¾ç¤ºæˆåŠŸæç¤º
      function showSuccessToast() {
        const toast = document.getElementById('successToast')
        toast.classList.add('show')

        setTimeout(() => {
          toast.classList.remove('show')
        }, 3000)
      }

      // è¿”å›åˆ—è¡¨ï¼ˆå…¨å±€å‡½æ•°ï¼Œä¾›å¯¼èˆªæ å’Œé¡µé¢æŒ‰é’®è°ƒç”¨ï¼‰
      window.goBack = function () {
        try {
          console.log('goBack function called')

          // è·å–å½“å‰è§’è‰²ï¼Œè¿”å›å¯¹åº”çš„å·¥ä½œå°é¡µé¢
          const role = sessionStorage.getItem('role')

          // æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„æ•°æ®
          const remarks = document.getElementById('remarks')?.value || ''
          const samplingDate =
            document.getElementById('samplingDate')?.value || ''
          const startTime = document.getElementById('startTime')?.value || ''
          const endTime = document.getElementById('endTime')?.value || ''
          const today = new Date().toISOString().split('T')[0]

          // åªæœ‰å½“ç”¨æˆ·ä¿®æ”¹äº†é»˜è®¤å€¼æˆ–é€‰æ‹©äº†äººå‘˜æ—¶æ‰ç®—æœ‰æœªä¿å­˜çš„æ•°æ®
          const hasUnsavedData =
            remarks.trim() !== '' ||
            selectedStaff.size > 0 ||
            (samplingDate !== '' && samplingDate !== today) ||
            startTime !== '' ||
            endTime !== ''

          if (hasUnsavedData) {
            if (!confirm('æ‚¨æœ‰æœªä¿å­˜çš„æ•°æ®ï¼Œç¡®å®šè¦è¿”å›å—ï¼Ÿ')) {
              return
            }
          }

          console.log('Navigating to sampling-dispatch.html')
          // è¿”å›åˆ°é‡‡æ ·è°ƒåº¦å·¥ä½œå°
          window.location.href = 'sampling-dispatch.html'
        } catch (error) {
          console.error('Error in goBack function:', error)
          // å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œç›´æ¥è·³è½¬
          window.location.href = 'sampling-dispatch.html'
        }
      }

      // ç¡®ä¿å¯¼èˆªæ çš„è¿”å›æŒ‰é’®ä¹Ÿä½¿ç”¨ç›¸åŒçš„é€»è¾‘
      document.addEventListener('DOMContentLoaded', () => {
        // ç­‰å¾…å¯¼èˆªæ åŠ è½½å®Œæˆåé‡æ–°ç»‘å®šè¿”å›æŒ‰é’®äº‹ä»¶
        setTimeout(() => {
          const navBackButton = document.getElementById('back-to-workspace')
          if (navBackButton) {
            // ç§»é™¤åŸæœ‰äº‹ä»¶ç›‘å¬å™¨ï¼Œä½¿ç”¨é¡µé¢çš„goBackå‡½æ•°
            navBackButton.replaceWith(navBackButton.cloneNode(true))
            const newNavBackButton =
              document.getElementById('back-to-workspace')
            if (newNavBackButton) {
              newNavBackButton.addEventListener('click', e => {
                e.preventDefault()
                e.stopPropagation()
                goBack()
              })
            }
          }
        }, 200)
      })
    </script>
  </body>
</html>
