<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ£€æµ‹ä»»åŠ¡è¯¦æƒ… - LIMS-XW</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC',
          'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        background: #f5f7fa;
        min-height: 100vh;
        margin: 0;
      }

      /* ä¸»å†…å®¹åŒº */
      .main-content {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
      }

      /* é¡µé¢æ ‡é¢˜ */
      .page-header {
        margin-bottom: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .page-title-section {
        flex: 1;
      }

      .page-title {
        font-size: 28px;
        color: #1f2937;
        font-weight: bold;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .project-number {
        color: #667eea;
      }

      .task-status {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }

      .task-status.pending {
        background: #fef3c7;
        color: #f59e0b;
      }

      .task-status.assigned {
        background: #dbeafe;
        color: #3b82f6;
      }

      .task-status.testing {
        background: #e0e7ff;
        color: #8b5cf6;
      }

      .task-status.completed {
        background: #d1fae5;
        color: #10b981;
      }

      /* åˆ†æ´¾è¡¨å•æ ·å¼ - å‚è€ƒ sampling-dispatch-detail.html */
      .assignment-form {
        background: #f8fafc;
        border-radius: 12px;
        padding: 24px;
        border: 1px solid #e2e8f0;
      }

      /* åˆ†æ´¾è¡¨å•åŒº - ä»¿ç…§ sampling-dispatch-detail.html */
      .dispatch-section {
        background: white;
        border-radius: 16px;
        box-shadow:
          0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        overflow: hidden;
      }

      .dispatch-header {
        padding: 20px 24px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
      }

      .dispatch-title {
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .dispatch-body {
        padding: 24px;
      }

      /* äººå‘˜é€‰æ‹©æ ·å¼ */
      .staff-select-container {
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        padding: 12px;
        background: #f9fafb;
        max-height: 250px;
        overflow-y: auto;
      }

      .staff-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 8px;
      }

      .staff-option:last-child {
        margin-bottom: 0;
      }

      .staff-option:hover {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.05);
      }

      .staff-option.selected {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.1);
      }

      .staff-checkbox-new {
        width: 20px;
        height: 20px;
        accent-color: #3b82f6;
      }

      .staff-info-new {
        flex: 1;
      }

      .staff-name-new {
        font-weight: 600;
        color: #1a202c;
        margin-bottom: 2px;
      }

      .staff-status-new {
        font-size: 12px;
        color: #6b7280;
      }

      .staff-tasks {
        padding: 4px 8px;
        background: #f3f4f6;
        border-radius: 6px;
        font-size: 12px;
        color: #4b5563;
        font-weight: 600;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      /* æ“ä½œæŒ‰é’® */
      .form-actions {
        display: flex;
        gap: 12px;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #374151;
        font-size: 14px;
      }

      .form-label .required {
        color: #ef4444;
      }

      .form-control {
        width: 100%;
        padding: 10px 14px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 14px;
        transition: all 0.3s;
        background: white;
      }

      .form-control:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .form-select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        background: white;
        cursor: pointer;
      }

      .form-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      /* å®ŒæˆçŠ¶æ€ç‰¹æœ‰æ ·å¼ */
      .completion-section {
        background: #f0f9ff;
        border-radius: 12px;
        padding: 24px;
        margin-top: 20px;
        border: 2px solid #0ea5e9;
      }

      .data-access-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-top: 20px;
      }

      .data-btn {
        padding: 16px;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        color: #374151;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }

      .data-btn:hover {
        border-color: #667eea;
        background: #f8fafc;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .data-btn-icon {
        font-size: 24px;
        margin-bottom: 4px;
      }

      .data-btn-title {
        font-weight: 600;
        font-size: 14px;
      }

      .data-btn-desc {
        font-size: 12px;
        color: #6b7280;
      }

      .breadcrumb {
        color: #6b7280;
        font-size: 14px;
      }

      .breadcrumb a {
        color: #667eea;
        text-decoration: none;
      }

      .page-actions {
        display: flex;
        gap: 12px;
      }

      .btn {
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }

      .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        flex: 1;
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        transform: translateY(-2px);
        box-shadow: 0 10px 20px -5px rgba(59, 130, 246, 0.3);
      }

      .btn-success {
        background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
        color: white;
      }

      .btn-warning {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: white;
      }

      .btn-secondary {
        background: #f3f4f6;
        color: #4b5563;
        flex: 1;
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .btn-secondary:hover {
        background: #e5e7eb;
        transform: translateX(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }

      /* å†…å®¹å¸ƒå±€ */
      .content-layout {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 20px;
      }

      .main-info {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .info-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .card-header {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
      }

      .info-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .info-label {
        font-size: 12px;
        color: #6b7280;
      }

      .info-value {
        font-size: 14px;
        color: #1f2937;
        font-weight: 500;
      }

      /* æ ·å“å¡ç‰‡ */
      .sample-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
      }

      .sample-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
      }

      .sample-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .sample-id {
        font-size: 14px;
        font-weight: 600;
        color: #667eea;
      }

      .sample-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .sample-status.good {
        background: #d1fae5;
        color: #10b981;
      }

      .sample-status.damaged {
        background: #fee2e2;
        color: #ef4444;
      }

      .sample-location {
        font-size: 13px;
        color: #1f2937;
        margin-bottom: 4px;
      }

      .sample-details {
        font-size: 12px;
        color: #6b7280;
      }

      /* æ£€æµ‹äººå‘˜åˆ—è¡¨ */
      .staff-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
      }

      .staff-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        position: relative;
      }

      .staff-card.selected {
        border-color: #667eea;
        background: #f0f4ff;
      }

      .staff-checkbox {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 18px;
        height: 18px;
      }

      .staff-info {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
      }

      .staff-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 16px;
        font-weight: bold;
      }

      .staff-name {
        font-size: 14px;
        font-weight: 600;
        color: #1f2937;
      }

      .staff-role {
        font-size: 12px;
        color: #6b7280;
      }

      .staff-workload {
        font-size: 12px;
        color: #6b7280;
      }

      /* åˆ†æ´¾æŒ‰é’® */
      .assign-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        width: 100%;
        margin-top: 16px;
      }

      .assign-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .assign-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* æ“ä½œæŒ‰é’®åŒº */
      .action-buttons {
        display: flex;
        gap: 12px;
        margin-top: 20px;
      }

      .action-btn {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .action-btn.start-btn {
        background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
        color: white;
      }

      .action-btn.end-btn {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: white;
      }

      .action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .action-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* ä¾§è¾¹æ  */
      .side-info {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .status-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .status-indicator {
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 16px;
      }

      .status-indicator.pending {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      }

      .status-indicator.assigned {
        background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      }

      .status-indicator.testing {
        background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
      }

      .status-indicator.completed {
        background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
      }

      .status-text {
        color: white;
        font-size: 18px;
        font-weight: 600;
      }

      .status-details {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .status-detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .status-detail-label {
        font-size: 14px;
        color: #6b7280;
      }

      .status-detail-value {
        font-size: 14px;
        font-weight: 500;
        color: #1f2937;
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 768px) {
        .content-layout {
          grid-template-columns: 1fr;
        }

        .info-grid {
          grid-template-columns: 1fr;
        }

        .sample-grid,
        .staff-grid {
          grid-template-columns: 1fr;
        }

        .action-buttons {
          flex-direction: column;
        }

        .page-actions {
          flex-direction: column;
          gap: 8px;
        }

        .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <script src="navigation.js"></script>

    <!-- ä¸»å†…å®¹ -->
    <div class="main-content">
      <!-- é¡µé¢å¤´éƒ¨ -->
      <div class="page-header">
        <div class="page-title-section">
          <h2 class="page-title">
            <span class="project-number">XW250903-100</span>
            <span class="task-status pending">å¾…åˆ†æ´¾</span>
          </h2>
        </div>
        <div class="page-actions" id="page-actions">
          <!-- åŠ¨æ€æ˜¾ç¤ºæŒ‰é’®ï¼Œæ ¹æ®å½“å‰ç”¨æˆ·è§’è‰²å’Œä»»åŠ¡çŠ¶æ€ -->
        </div>
      </div>

      <!-- å†…å®¹å¸ƒå±€ -->
      <div class="content-layout">
        <!-- å·¦ä¾§ä¸»ä¿¡æ¯åŒº -->
        <div class="main-info">
          <!-- åŸºæœ¬ä¿¡æ¯ -->
          <div class="info-card">
            <div class="card-header">åŸºæœ¬ä¿¡æ¯</div>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">å®¢æˆ·åç§°</span>
                <span class="info-value">å¹¿å·ç¯ä¿ç§‘æŠ€æœ‰é™å…¬å¸</span>
              </div>
              <div class="info-item">
                <span class="info-label">å—æ£€å•ä½</span>
                <span class="info-value">å¹¿å·ç¯ä¿ç§‘æŠ€æ€»éƒ¨</span>
              </div>
              <div class="info-item">
                <span class="info-label">é‡‡æ ·åœ°å€</span>
                <span class="info-value">å¹¿å·å¸‚å¤©æ²³åŒºç§‘æŠ€å›­Aæ ‹3æ¥¼</span>
              </div>
              <div class="info-item">
                <span class="info-label">é”€å”®äººå‘˜</span>
                <span class="info-value">å¼ ä¸‰</span>
              </div>
              <div class="info-item">
                <span class="info-label">é‡‡æ ·äººå‘˜</span>
                <span class="info-value">èµµå…­</span>
              </div>
              <div class="info-item">
                <span class="info-label">æ ·å“ç®¡ç†å‘˜</span>
                <span class="info-value">æä¸ƒ</span>
              </div>
            </div>
          </div>

          <!-- æ£€æµ‹ä¿¡æ¯ -->
          <div class="info-card">
            <div class="card-header">æ£€æµ‹ä¿¡æ¯</div>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">æ£€æµ‹ç±»å‹</span>
                <span
                  class="info-value"
                  style="color: #059669; font-weight: 600"
                  >50325-2020</span
                >
              </div>
              <div class="info-item">
                <span class="info-label">æ£€æµ‹å†…å®¹</span>
                <span
                  class="info-value"
                  style="color: #059669; font-weight: 500"
                  >ä¸‰è‹¯äº”é¡¹ï¼šç”²é†›ã€è‹¯ã€ç”²è‹¯ã€äºŒç”²è‹¯ã€TVOC</span
                >
              </div>
              <div class="info-item">
                <span class="info-label">æ ·å“æ•°é‡</span>
                <span class="info-value">12ä¸ª</span>
              </div>
              <div class="info-item">
                <span class="info-label">å®Œå¥½æ ·å“</span>
                <span class="info-value" style="color: #10b981">11ä¸ª</span>
              </div>
              <div class="info-item">
                <span class="info-label">ç ´æŸæ ·å“</span>
                <span class="info-value" style="color: #ef4444">1ä¸ª</span>
              </div>
              <div class="info-item">
                <span class="info-label">æ¥æ”¶æ—¶é—´</span>
                <span class="info-value">2025-09-04 17:30</span>
              </div>
            </div>
          </div>

          <!-- æ ·å“åˆ—è¡¨ -->
          <div class="info-card">
            <div class="card-header">æ ·å“åˆ—è¡¨</div>
            <div class="sample-grid">
              <div class="sample-card">
                <div class="sample-header">
                  <span class="sample-id">XW250903-100-001</span>
                  <span class="sample-status good">å®Œå¥½</span>
                </div>
                <div class="sample-location">åŠå…¬å®¤AåŒºåŸŸ</div>
                <div class="sample-details">æ¥æ”¶æ—¶é—´ï¼š2025-09-04 17:30</div>
              </div>

              <div class="sample-card">
                <div class="sample-header">
                  <span class="sample-id">XW250903-100-002</span>
                  <span class="sample-status good">å®Œå¥½</span>
                </div>
                <div class="sample-location">ä¼šè®®å®¤BåŒºåŸŸ</div>
                <div class="sample-details">æ¥æ”¶æ—¶é—´ï¼š2025-09-04 17:30</div>
              </div>

              <div class="sample-card">
                <div class="sample-header">
                  <span class="sample-id">XW250903-100-003</span>
                  <span class="sample-status good">å®Œå¥½</span>
                </div>
                <div class="sample-location">æ€»ç»ç†åŠå…¬å®¤</div>
                <div class="sample-details">æ¥æ”¶æ—¶é—´ï¼š2025-09-04 17:30</div>
              </div>

              <div class="sample-card">
                <div class="sample-header">
                  <span class="sample-id">XW250903-100-004</span>
                  <span class="sample-status damaged">ç ´æŸ</span>
                </div>
                <div class="sample-location">è´¢åŠ¡å®¤</div>
                <div class="sample-details">æ¥æ”¶æ—¶é—´ï¼š2025-09-04 17:30</div>
              </div>

              <!-- ç®€åŒ–æ˜¾ç¤ºï¼Œå®é™…åº”è¯¥æ˜¾ç¤ºæ‰€æœ‰12ä¸ªæ ·å“ -->
              <div class="sample-card">
                <div class="sample-header">
                  <span class="sample-id">...</span>
                  <span class="sample-status good">æ›´å¤šæ ·å“</span>
                </div>
                <div class="sample-location">å…±è®¡12ä¸ªæ ·å“</div>
                <div class="sample-details">ç‚¹å‡»æŸ¥çœ‹å…¨éƒ¨</div>
              </div>
            </div>
          </div>

          <!-- æ£€æµ‹äººå‘˜åˆ†æ´¾ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰ -->
          <div
            class="info-card"
            id="staff-assignment-section"
            style="display: none"
          >
            <div class="card-header">æ£€æµ‹äººå‘˜åˆ†æ´¾</div>
            <div class="staff-grid">
              <div class="staff-card" onclick="toggleStaffSelection(this)">
                <input
                  type="checkbox"
                  class="staff-checkbox"
                  value="staff_001"
                />
                <div class="staff-info">
                  <div class="staff-avatar">ç‹</div>
                  <div>
                    <div class="staff-name">ç‹å…«</div>
                    <div class="staff-role">é«˜çº§æ£€æµ‹å‘˜</div>
                  </div>
                </div>
                <div class="staff-workload">å½“å‰ä»»åŠ¡ï¼š2ä¸ª</div>
              </div>

              <div class="staff-card" onclick="toggleStaffSelection(this)">
                <input
                  type="checkbox"
                  class="staff-checkbox"
                  value="staff_002"
                />
                <div class="staff-info">
                  <div class="staff-avatar">å­™</div>
                  <div>
                    <div class="staff-name">å­™ä¹</div>
                    <div class="staff-role">æ£€æµ‹å‘˜</div>
                  </div>
                </div>
                <div class="staff-workload">å½“å‰ä»»åŠ¡ï¼š1ä¸ª</div>
              </div>

              <div class="staff-card" onclick="toggleStaffSelection(this)">
                <input
                  type="checkbox"
                  class="staff-checkbox"
                  value="staff_003"
                />
                <div class="staff-info">
                  <div class="staff-avatar">å‘¨</div>
                  <div>
                    <div class="staff-name">å‘¨å</div>
                    <div class="staff-role">æ£€æµ‹å‘˜</div>
                  </div>
                </div>
                <div class="staff-workload">å½“å‰ä»»åŠ¡ï¼š3ä¸ª</div>
              </div>
            </div>
            <button class="assign-btn" onclick="assignStaff()">ç¡®è®¤åˆ†æ´¾</button>
          </div>

          <!-- æ£€æµ‹æ“ä½œï¼ˆä»…æ£€æµ‹äººå‘˜å¯è§ï¼‰ -->
          <div
            class="info-card"
            id="testing-actions-section"
            style="display: none"
          >
            <div class="card-header">æ£€æµ‹æ“ä½œ</div>
            <div class="action-buttons">
              <button class="action-btn start-btn" onclick="startTesting()">
                å¼€å§‹æ£€æµ‹
              </button>
              <button class="action-btn end-btn" onclick="endTesting()">
                ç»“æŸæ£€æµ‹
              </button>
            </div>
            <div
              style="
                margin-top: 16px;
                padding: 12px;
                background: #f0f9ff;
                border-radius: 6px;
                font-size: 13px;
                color: #1e40af;
              "
            >
              <strong>æ³¨æ„ï¼š</strong
              >å¼€å§‹æ£€æµ‹åå°†è®°å½•æ£€æµ‹å¼€å§‹æ—¶é—´ï¼Œç»“æŸæ£€æµ‹åå°†è®°å½•æ£€æµ‹ç»“æŸæ—¶é—´ï¼Œè¿™äº›æ—¶é—´å°†æ˜¾ç¤ºåœ¨æœ€ç»ˆæŠ¥å‘Šä¸­ã€‚
            </div>
          </div>
        </div>

        <!-- å³ä¾§çŠ¶æ€åŒº -->
        <div class="side-info">
          <!-- ä»»åŠ¡çŠ¶æ€æŒ‡ç¤ºå™¨ -->
          <div class="status-card">
            <div class="status-indicator pending" id="status-indicator">
              <div class="status-text" id="status-text">å¾…åˆ†æ´¾</div>
            </div>
            <div class="status-details" id="status-details">
              <div class="status-detail-item">
                <span class="status-detail-label">å½“å‰é˜¶æ®µ</span>
                <span class="status-detail-value" id="current-phase"
                  >ç­‰å¾…åˆ†æ´¾</span
                >
              </div>
              <div class="status-detail-item">
                <span class="status-detail-label">ä¼˜å…ˆçº§</span>
                <span class="status-detail-value" style="color: #ef4444"
                  >åŠ æ€¥</span
                >
              </div>
              <div class="status-detail-item">
                <span class="status-detail-label">åˆ†æ´¾æ—¶é—´</span>
                <span class="status-detail-value" id="assign-time"
                  >2025-09-04 18:00</span
                >
              </div>
              <div class="status-detail-item" id="completion-time-row">
                <span class="status-detail-label" id="completion-time-label"
                  >é¢„è®¡å®Œæˆ</span
                >
                <span class="status-detail-value" id="expected-end"
                  >2025-09-06</span
                >
              </div>
            </div>
          </div>

          <!-- åŠ¨æ€å†…å®¹åŒº -->
          <div id="dynamic-content">
            <!-- æ ¹æ®çŠ¶æ€åŠ¨æ€æ˜¾ç¤ºä¸åŒå†…å®¹ -->
          </div>

          <!-- ä»»åŠ¡ç»Ÿè®¡ï¼ˆå¾…åˆ†æ´¾çŠ¶æ€æ—¶éšè—ï¼‰ -->
          <div class="status-card" id="task-statistics">
            <div class="card-header">ä»»åŠ¡ç»Ÿè®¡</div>
            <div
              style="
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
              "
            >
              <div
                style="
                  background: #f9fafb;
                  padding: 16px;
                  border-radius: 8px;
                  text-align: center;
                "
              >
                <div style="font-size: 24px; font-weight: bold; color: #667eea">
                  5
                </div>
                <div style="font-size: 12px; color: #6b7280">æ£€æµ‹é¡¹ç›®</div>
              </div>
              <div
                style="
                  background: #f9fafb;
                  padding: 16px;
                  border-radius: 8px;
                  text-align: center;
                "
              >
                <div style="font-size: 24px; font-weight: bold; color: #10b981">
                  12
                </div>
                <div style="font-size: 12px; color: #6b7280">æ£€æµ‹æ ·å“</div>
              </div>
              <div
                style="
                  background: #f9fafb;
                  padding: 16px;
                  border-radius: 8px;
                  text-align: center;
                "
              >
                <div
                  style="font-size: 24px; font-weight: bold; color: #f59e0b"
                  id="assigned-staff-count"
                >
                  2
                </div>
                <div style="font-size: 12px; color: #6b7280">åˆ†æ´¾äººå‘˜</div>
              </div>
              <div
                style="
                  background: #f9fafb;
                  padding: 16px;
                  border-radius: 8px;
                  text-align: center;
                "
              >
                <div style="font-size: 24px; font-weight: bold; color: #ef4444">
                  1
                </div>
                <div style="font-size: 12px; color: #6b7280">ç ´æŸæ ·å“</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // æƒé™éªŒè¯
      function checkPermission() {
        const role = sessionStorage.getItem('role')
        const allowedRoles = ['lab-supervisor', 'admin']

        if (!allowedRoles.includes(role)) {
          alert('æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡µé¢ï¼Œå³å°†è·³è½¬åˆ°æ‚¨çš„å·¥ä½œå°ã€‚')
          // æ ¹æ®è§’è‰²è·³è½¬åˆ°ç›¸åº”é¡µé¢
          if (role === 'lab-technician') {
            window.location.href = 'staff-tasks.html'
          } else {
            window.location.href = 'login.html'
          }
          return false
        }
        return true
      }

      // æ¨¡æ‹Ÿå½“å‰ç”¨æˆ·è§’è‰²ï¼Œå®é™…åº”è¯¥ä»sessionè·å–
      const currentUserRole = sessionStorage.getItem('role') || 'lab-supervisor'

      // è°ƒè¯•ä¿¡æ¯ï¼šè¾“å‡ºå½“å‰ç”¨æˆ·è§’è‰²
      console.log('å½“å‰ç”¨æˆ·è§’è‰²:', currentUserRole)
      console.log('sessionStorageä¸­çš„è§’è‰²:', sessionStorage.getItem('role'))

      // ä»URLå‚æ•°è·å–ä»»åŠ¡çŠ¶æ€
      function getUrlParameter(name) {
        const urlParams = new URLSearchParams(window.location.search)
        return urlParams.get(name)
      }

      let taskStatus = getUrlParameter('status') || 'pending' // pending, assigned, testing, processing, completed
      const taskNumber = getUrlParameter('task') || 'XW250903-100'

      // è·Ÿè¸ªè¡¨å•å˜æ›´çŠ¶æ€
      let hasUnsavedChanges = false
      let originalData = {}

      // é¡µé¢å¸è½½å‰æ£€æŸ¥æœªä¿å­˜çš„æ›´æ”¹
      window.addEventListener('beforeunload', function (e) {
        if (hasUnsavedChanges) {
          e.preventDefault()
          e.returnValue = 'æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€æ­¤é¡µé¢å—ï¼Ÿ'
          return e.returnValue
        }
      })

      // ç›‘å¬å¯¼èˆªæ è¿”å›æŒ‰é’®ç‚¹å‡»ï¼ˆè¦†ç›–é»˜è®¤è¡Œä¸ºï¼‰
      document.addEventListener('DOMContentLoaded', function () {
        setTimeout(function () {
          const backButton = document.getElementById('back-to-workspace')
          if (backButton) {
            // ç§»é™¤åŸæœ‰äº‹ä»¶ç›‘å¬å™¨å¹¶æ·»åŠ æ–°çš„
            const newButton = backButton.cloneNode(true)
            backButton.parentNode.replaceChild(newButton, backButton)
            newButton.addEventListener('click', handleBackToWorkspace)
          }
        }, 100)
      })

      // å¤„ç†è¿”å›å·¥ä½œå°æ“ä½œ
      function handleBackToWorkspace(e) {
        e.preventDefault()
        e.stopPropagation()

        if (hasUnsavedChanges) {
          const confirmLeave = confirm(
            'æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦è¿”å›å·¥ä½œå°å—ï¼Ÿæœªä¿å­˜çš„æ›´æ”¹å°†ä¸¢å¤±ã€‚'
          )
          if (!confirmLeave) {
            return
          }
        }

        // è·å–å½“å‰ç”¨æˆ·è§’è‰²å¯¹åº”çš„å·¥ä½œå°é¡µé¢
        const roleWorkspaceMap = {
          'lab-supervisor': 'lab-dashboard.html',
          'lab-technician': 'staff-tasks.html'
        }

        const workspacePage =
          roleWorkspaceMap[currentUserRole] || 'lab-dashboard.html'

        // ä¸»è¦å¯¼èˆªæ–¹æ³•
        try {
          window.location.href = workspacePage
        } catch (error) {
          console.error('å¯¼èˆªå¤±è´¥ï¼š', error)

          // å¤‡ç”¨å¯¼èˆªæ–¹æ³•1ï¼šä½¿ç”¨ replace
          try {
            window.location.replace(workspacePage)
          } catch (replaceError) {
            console.error('replace å¯¼èˆªå¤±è´¥ï¼š', replaceError)

            // å¤‡ç”¨å¯¼èˆªæ–¹æ³•2ï¼šä½¿ç”¨ assign
            try {
              window.location.assign(workspacePage)
            } catch (assignError) {
              console.error('assign å¯¼èˆªå¤±è´¥ï¼š', assignError)

              // æœ€åçš„å¤‡ç”¨æ–¹æ³•ï¼šåˆ·æ–°åˆ°æ ¹ç›®å½•
              alert('å¯¼èˆªå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¿”å›å·¥ä½œå°é¡µé¢')
              window.location.href = '/'
            }
          }
        }
      }

      // è®¾ç½®é¡µé¢æ ‡é¢˜
      document.addEventListener('DOMContentLoaded', () => {
        // é¦–å…ˆæ£€æŸ¥æƒé™
        if (!checkPermission()) {
          return
        }

        if (window.limsNav) {
          window.limsNav.setPageTitle('æ£€æµ‹ä»»åŠ¡è¯¦æƒ…')
        }
        initializePage()
      })

      // åˆå§‹åŒ–é¡µé¢
      function initializePage() {
        updateTaskInfo()
        updatePageActions()
        updateStatusDisplay()
        renderDynamicContent()
      }

      // æ›´æ–°ä»»åŠ¡ä¿¡æ¯
      function updateTaskInfo() {
        // æ›´æ–°é¡µé¢æ ‡é¢˜ä¸­çš„ä»»åŠ¡ç¼–å·
        document.querySelector('.project-number').textContent = taskNumber

        // æ ¹æ®çŠ¶æ€æ›´æ–°ä»»åŠ¡çŠ¶æ€æ ‡ç­¾
        const statusElement = document.querySelector('.task-status')
        const statusMap = {
          pending: { class: 'pending', text: 'å¾…åˆ†æ´¾' },
          assigned: { class: 'assigned', text: 'å·²åˆ†æ´¾' },
          testing: { class: 'testing', text: 'æ£€æµ‹ä¸­' },
          processing: { class: 'testing', text: 'æ£€æµ‹ä¸­' },
          completed: { class: 'completed', text: 'å·²å®Œæˆ' }
        }

        const statusInfo = statusMap[taskStatus] || statusMap['assigned']
        statusElement.className = `task-status ${statusInfo.class}`
        statusElement.textContent = statusInfo.text
      }

      // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
      function updateStatusDisplay() {
        const statusIndicator = document.getElementById('status-indicator')
        const statusText = document.getElementById('status-text')
        const currentPhase = document.getElementById('current-phase')
        const completionTimeLabel = document.getElementById(
          'completion-time-label'
        )
        const expectedEnd = document.getElementById('expected-end')
        const statusDetails = document.getElementById('status-details')
        const assignTimeRow = statusDetails.querySelector(
          '.status-detail-item:nth-child(3)'
        )
        const completionTimeRow = document.getElementById('completion-time-row')

        const statusConfig = {
          pending: {
            class: 'pending',
            text: 'å¾…åˆ†æ´¾',
            phase: 'ç­‰å¾…åˆ†æ´¾'
          },
          assigned: {
            class: 'assigned',
            text: 'å·²åˆ†æ´¾',
            phase: 'ç­‰å¾…å¼€å§‹æ£€æµ‹'
          },
          testing: {
            class: 'testing',
            text: 'æ£€æµ‹ä¸­',
            phase: 'æ­£åœ¨æ£€æµ‹'
          },
          processing: {
            class: 'testing',
            text: 'æ£€æµ‹ä¸­',
            phase: 'æ­£åœ¨æ£€æµ‹'
          },
          completed: {
            class: 'completed',
            text: 'å·²å®Œæˆ',
            phase: 'æ£€æµ‹å®Œæˆ'
          }
        }

        const config = statusConfig[taskStatus] || statusConfig['assigned']
        statusIndicator.className = `status-indicator ${config.class}`
        statusText.textContent = config.text
        currentPhase.textContent = config.phase

        // å¾…åˆ†æ´¾çŠ¶æ€ï¼šéšè—åˆ†æ´¾æ—¶é—´å’Œé¢„è®¡å®Œæˆå­—æ®µ
        if (taskStatus === 'pending') {
          if (assignTimeRow) assignTimeRow.style.display = 'none'
          if (completionTimeRow) completionTimeRow.style.display = 'none'
        } else {
          if (assignTimeRow) assignTimeRow.style.display = 'flex'
          if (completionTimeRow) completionTimeRow.style.display = 'flex'
        }

        // æ ¹æ®çŠ¶æ€éšè—/æ˜¾ç¤ºä»»åŠ¡ç»Ÿè®¡
        const taskStatistics = document.getElementById('task-statistics')
        if (taskStatistics) {
          taskStatistics.style.display =
            taskStatus === 'pending' ? 'none' : 'block'
        }

        // æ ¹æ®çŠ¶æ€æ›´æ–°æ—¶é—´æ˜¾ç¤º
        if (taskStatus === 'completed') {
          // å·²å®ŒæˆçŠ¶æ€ï¼šæ˜¾ç¤ºå®é™…å®Œæˆæ—¶é—´
          completionTimeLabel.textContent = 'å®é™…å®Œæˆ'
          expectedEnd.textContent = '2025-09-06 16:45'
        } else if (taskStatus === 'testing' || taskStatus === 'processing') {
          // æ£€æµ‹ä¸­çŠ¶æ€ï¼šæ˜¾ç¤ºé¢„è®¡å®Œæˆï¼Œå¹¶æ·»åŠ å®é™…å¼€å§‹æ—¶é—´
          completionTimeLabel.textContent = 'é¢„è®¡å®Œæˆ'
          expectedEnd.textContent = '2025-09-07 17:00'

          // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å®é™…å¼€å§‹æ—¶é—´è¡Œï¼Œå¦‚æœæ²¡æœ‰åˆ™æ·»åŠ 
          if (!document.getElementById('actual-start-row')) {
            const actualStartRow = document.createElement('div')
            actualStartRow.className = 'status-detail-item'
            actualStartRow.id = 'actual-start-row'
            actualStartRow.innerHTML = `
                        <span class="status-detail-label">å®é™…å¼€å§‹</span>
                        <span class="status-detail-value">2025-09-05 09:30</span>
                    `

            // åœ¨åˆ†æ´¾æ—¶é—´åæ’å…¥å®é™…å¼€å§‹æ—¶é—´
            const assignTimeRow = statusDetails.querySelector(
              '.status-detail-item:nth-child(3)'
            )
            assignTimeRow.insertAdjacentElement('afterend', actualStartRow)
          }
        } else {
          // å…¶ä»–çŠ¶æ€ï¼šæ˜¾ç¤ºé¢„è®¡å®Œæˆ
          completionTimeLabel.textContent = 'é¢„è®¡å®Œæˆ'
          expectedEnd.textContent = '2025-09-06'

          // ç§»é™¤å®é™…å¼€å§‹æ—¶é—´è¡Œï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          const actualStartRow = document.getElementById('actual-start-row')
          if (actualStartRow) {
            actualStartRow.remove()
          }
        }
      }

      // æ¸²æŸ“åŠ¨æ€å†…å®¹
      function renderDynamicContent() {
        const dynamicContent = document.getElementById('dynamic-content')

        switch (taskStatus) {
          case 'pending':
            dynamicContent.innerHTML = renderPendingContent()
            // å¦‚æœæ˜¯å¾…åˆ†æ´¾çŠ¶æ€ï¼Œåˆå§‹åŒ–äººå‘˜é€‰æ‹©
            console.log('å‡†å¤‡åˆå§‹åŒ–äººå‘˜é€‰æ‹©...')
            // ä½¿ç”¨æ›´é•¿çš„å»¶è¿Ÿç¡®ä¿DOMå…ƒç´ å·²åˆ›å»ºï¼Œå¹¶æ·»åŠ é‡è¯•æœºåˆ¶
            setTimeout(() => {
              const container = document.getElementById('staffSelectContainer')
              if (container) {
                console.log('æ‰¾åˆ°äººå‘˜é€‰æ‹©å®¹å™¨ï¼Œå¼€å§‹åˆå§‹åŒ–')
                initializeStaffSelect()
              } else {
                console.log('æœªæ‰¾åˆ°äººå‘˜é€‰æ‹©å®¹å™¨ï¼Œ3ç§’åé‡è¯•')
                setTimeout(() => initializeStaffSelect(), 3000)
              }
            }, 200)
            break
          case 'assigned':
            dynamicContent.innerHTML = renderAssignedContent()
            break
          case 'testing':
          case 'processing':
            dynamicContent.innerHTML = renderTestingContent()
            break
          case 'completed':
            dynamicContent.innerHTML = renderCompletedContent()
            break
          default:
            dynamicContent.innerHTML = renderAssignedContent()
        }
      }

      // æ¸²æŸ“å¾…åˆ†æ´¾çŠ¶æ€å†…å®¹
      function renderPendingContent() {
        console.log('renderPendingContent - å½“å‰ç”¨æˆ·è§’è‰²:', currentUserRole)
        // ç§»é™¤è§’è‰²åˆ¤æ–­ï¼Œå§‹ç»ˆæ˜¾ç¤ºåˆ†æ´¾è¡¨å•
        console.log('æ˜¾ç¤ºåˆ†æ´¾è¡¨å•')

        return `
                <div class="dispatch-section">
                    <div class="dispatch-header">
                        <div class="dispatch-title">
                            <span>ğŸ§ª</span>
                            <span>æ£€æµ‹ä»»åŠ¡åˆ†æ´¾</span>
                        </div>
                    </div>
                    <div class="dispatch-body">
                        <form id="dispatchForm">
                            <div class="form-group">
                                <label class="form-label">
                                    æ£€æµ‹å¼€å§‹æ—¥æœŸ <span class="required">*</span>
                                </label>
                                <input type="date" class="form-control" id="start-date" value="${new Date(Date.now() + 86400000).toISOString().split('T')[0]}" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    æ£€æµ‹ç»“æŸæ—¥æœŸ <span class="required">*</span>
                                </label>
                                <input type="date" class="form-control" id="end-date" value="${new Date(Date.now() + 3 * 86400000).toISOString().split('T')[0]}" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    æ£€æµ‹äººå‘˜ <span class="required">*</span>
                                    <span style="font-size: 12px; color: #6b7280; font-weight: normal; margin-left: 8px;">å¯å¤šé€‰</span>
                                </label>
                                <div class="staff-select-container" id="staffSelectContainer">
                                    <!-- äººå‘˜é€‰é¡¹å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">å¤‡æ³¨è¯´æ˜</label>
                                <textarea class="form-control" id="dispatch-remarks" 
                                          placeholder="è¯·è¾“å…¥ç‰¹æ®Šè¦æ±‚æˆ–æ³¨æ„äº‹é¡¹..." 
                                          style="resize: vertical; min-height: 80px;"></textarea>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="handleBackToWorkspace(event)">
                                    <span>â†</span>
                                    <span>è¿”å›å·¥ä½œå°</span>
                                </button>
                                <button type="submit" class="btn btn-primary" onclick="assignTask(event)">
                                    <span>âœ“</span>
                                    <span>ç«‹å³åˆ†æ´¾</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `
      }

      // æ¸²æŸ“å·²åˆ†æ´¾çŠ¶æ€å†…å®¹
      function renderAssignedContent() {
        // å°è¯•ä» sessionStorage è·å–åˆ†æ´¾ä¿¡æ¯
        const dispatchInfo = sessionStorage.getItem(`dispatch_${taskNumber}`)
        let staffNames = 'ç‹å…«ã€å­™ä¹'
        let startDate = '2025-09-05'
        let endDate = '2025-09-07'
        let remarks = ''

        if (dispatchInfo) {
          const info = JSON.parse(dispatchInfo)
          staffNames = info.staff.join('ã€')
          startDate = info.startDate
          endDate = info.endDate
          remarks = info.remarks || ''
        }

        return `
                <div class="status-card">
                    <div class="card-header">åˆ†æ´¾ä¿¡æ¯</div>
                    <div class="status-details">
                        <div class="status-detail-item">
                            <span class="status-detail-label">åˆ†æ´¾äººå‘˜</span>
                            <span class="status-detail-value">${staffNames}</span>
                        </div>
                        <div class="status-detail-item">
                            <span class="status-detail-label">å¼€å§‹æ—¥æœŸ</span>
                            <span class="status-detail-value">${startDate}</span>
                        </div>
                        <div class="status-detail-item">
                            <span class="status-detail-label">ç»“æŸæ—¥æœŸ</span>
                            <span class="status-detail-value">${endDate}</span>
                        </div>
                        ${
                          remarks
                            ? `
                        <div class="status-detail-item" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                            <span class="status-detail-label">å¤‡æ³¨è¯´æ˜</span>
                            <span class="status-detail-value" style="font-size: 13px; line-height: 1.5;">${remarks}</span>
                        </div>
                        `
                            : ''
                        }
                    </div>
                    ${
                      currentUserRole === 'lab-supervisor'
                        ? '<button class="btn btn-warning" style="width: 100%; margin-top: 16px;" onclick="reassignTask()">é‡æ–°åˆ†æ´¾</button>'
                        : currentUserRole === 'lab-technician'
                          ? '<button class="btn btn-success" style="width: 100%; margin-top: 16px;" onclick="startTesting()">å¼€å§‹æ£€æµ‹</button>'
                          : ''
                    }
                </div>
            `
      }

      // æ¸²æŸ“æ£€æµ‹ä¸­çŠ¶æ€å†…å®¹
      function renderTestingContent() {
        return `
                <div class="status-card">
                    <div class="card-header">æ£€æµ‹è¿›åº¦</div>
                    <div class="status-details">
                        <div class="status-detail-item">
                            <span class="status-detail-label">å®é™…å¼€å§‹</span>
                            <span class="status-detail-value">2025-09-05 09:30</span>
                        </div>
                        <div class="status-detail-item">
                            <span class="status-detail-label">é¢„è®¡ç»“æŸ</span>
                            <span class="status-detail-value">2025-09-07 17:00</span>
                        </div>
                        <div class="status-detail-item">
                            <span class="status-detail-label">è¿›åº¦</span>
                            <span class="status-detail-value" style="color: #667eea; font-weight: 600;">65%</span>
                        </div>
                        <div class="status-detail-item">
                            <span class="status-detail-label">æ£€æµ‹äººå‘˜</span>
                            <span class="status-detail-value">ç‹å…«ã€å­™ä¹</span>
                        </div>
                    </div>
                    ${
                      currentUserRole === 'lab-technician'
                        ? '<button class="btn btn-warning" style="width: 100%; margin-top: 16px;" onclick="endTesting()">ç»“æŸæ£€æµ‹</button>'
                        : ''
                    }
                </div>
            `
      }

      // æ¸²æŸ“å·²å®ŒæˆçŠ¶æ€å†…å®¹
      function renderCompletedContent() {
        return `
                <div class="completion-section">
                    <div class="card-header" style="color: #0ea5e9; border-bottom: 1px solid #0ea5e9; margin-bottom: 20px;">æ£€æµ‹å®Œæˆ</div>
                    <div class="status-details">
                        <div class="status-detail-item">
                            <span class="status-detail-label">å®é™…å¼€å§‹</span>
                            <span class="status-detail-value">2025-09-05 09:30</span>
                        </div>
                        <div class="status-detail-item">
                            <span class="status-detail-label">å®é™…å®Œæˆ</span>
                            <span class="status-detail-value">2025-09-06 16:45</span>
                        </div>
                        <div class="status-detail-item">
                            <span class="status-detail-label">å®é™…å¤©æ•°</span>
                            <span class="status-detail-value">1.5å¤©</span>
                        </div>
                    </div>
                    <div class="data-access-buttons">
                        <a href="#" class="data-btn" onclick="viewTestReport()">
                            <div class="data-btn-icon">ğŸ“Š</div>
                            <div class="data-btn-title">æŸ¥çœ‹æ£€æµ‹æŠ¥å‘Š</div>
                            <div class="data-btn-desc">PDFæ ¼å¼æŠ¥å‘Š</div>
                        </a>
                        <a href="#" class="data-btn" onclick="downloadData()">
                            <div class="data-btn-icon">ğŸ“¥</div>
                            <div class="data-btn-title">ä¸‹è½½æ£€æµ‹æ•°æ®</div>
                            <div class="data-btn-desc">ExcelåŸå§‹æ•°æ®</div>
                        </a>
                        <a href="#" class="data-btn" onclick="viewCertificate()">
                            <div class="data-btn-icon">ğŸ†</div>
                            <div class="data-btn-title">æŸ¥çœ‹æ£€æµ‹è¯ä¹¦</div>
                            <div class="data-btn-desc">å®˜æ–¹è®¤è¯æ–‡ä»¶</div>
                        </a>
                    </div>
                </div>
            `
      }

      // æ›´æ–°é¡µé¢æ“ä½œæŒ‰é’®
      function updatePageActions() {
        const pageActions = document.getElementById('page-actions')
        let actionsHTML =
          '<button class="btn btn-secondary" onclick="exportTaskInfo()">å¯¼å‡ºä»»åŠ¡ä¿¡æ¯</button>'

        // æ ¹æ®çŠ¶æ€å’Œç”¨æˆ·è§’è‰²æ˜¾ç¤ºä¸åŒæŒ‰é’®
        if (currentUserRole === 'lab-supervisor') {
          if (taskStatus === 'pending') {
            actionsHTML +=
              '<button class="btn btn-primary" onclick="scrollToAssignment()">åˆ†æ´¾ä»»åŠ¡</button>'
          } else if (
            taskStatus === 'assigned' ||
            taskStatus === 'testing' ||
            taskStatus === 'processing'
          ) {
            actionsHTML +=
              '<button class="btn btn-warning" onclick="reassignTask()">é‡æ–°åˆ†æ´¾</button>'
          }
        } else if (currentUserRole === 'lab-technician') {
          if (taskStatus === 'assigned') {
            actionsHTML +=
              '<button class="btn btn-success" onclick="startTesting()">å¼€å§‹æ£€æµ‹</button>'
          } else if (taskStatus === 'testing' || taskStatus === 'processing') {
            actionsHTML +=
              '<button class="btn btn-warning" onclick="endTesting()">ç»“æŸæ£€æµ‹</button>'
          }
        }

        if (taskStatus === 'completed') {
          actionsHTML +=
            '<button class="btn btn-primary" onclick="viewTestReport()">æŸ¥çœ‹æŠ¥å‘Š</button>'
        }

        pageActions.innerHTML = actionsHTML
      }

      // æ–°çš„æ“ä½œå‡½æ•°

      // åˆ†æ´¾ä»»åŠ¡ï¼ˆæ–°ç‰ˆæœ¬ï¼‰
      function assignTask(event) {
        if (event) {
          event.preventDefault()
          event.stopPropagation()
        }

        const startDate = document.getElementById('start-date')?.value
        const endDate = document.getElementById('end-date')?.value
        const remarks = document.getElementById('dispatch-remarks')?.value

        // éªŒè¯è¡¨å•æ•°æ®
        if (!startDate || !endDate) {
          alert('è¯·å¡«å†™å¼€å§‹å’Œç»“æŸæ—¥æœŸ')
          return
        }

        if (selectedStaff.size === 0) {
          alert('è¯·è‡³å°‘é€‰æ‹©ä¸€åæ£€æµ‹äººå‘˜')
          return
        }

        // éªŒè¯æ—¥æœŸé€»è¾‘
        const startDateTime = new Date(startDate)
        const endDateTime = new Date(endDate)

        if (startDateTime >= endDateTime) {
          alert('æ£€æµ‹ç»“æŸæ—¥æœŸå¿…é¡»æ™šäºå¼€å§‹æ—¥æœŸ')
          return
        }

        // è·å–é€‰ä¸­äººå‘˜åç§°
        const selectedStaffNames = Array.from(selectedStaff)
          .map(id => {
            const staff = staffList.find(s => s.id === id)
            return staff ? staff.name : ''
          })
          .filter(name => name)

        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        let confirmMessage = `ç¡®è®¤åˆ†æ´¾ä»»åŠ¡ï¼Ÿ\n\n`
        confirmMessage += `åˆ†æ´¾äººå‘˜ï¼š${selectedStaffNames.join('ã€')}\n`
        confirmMessage += `å¼€å§‹æ—¥æœŸï¼š${startDate}\n`
        confirmMessage += `ç»“æŸæ—¥æœŸï¼š${endDate}`
        if (remarks.trim()) {
          confirmMessage += `\nå¤‡æ³¨ï¼š${remarks}`
        }

        if (confirm(confirmMessage)) {
          // ä¿å­˜åˆ†æ´¾ä¿¡æ¯ï¼ˆå®é™…åº”ç”¨ä¸­åº”å‘é€åˆ°åç«¯ï¼‰
          const dispatchInfo = {
            taskNumber: taskNumber,
            staff: selectedStaffNames,
            startDate: startDate,
            endDate: endDate,
            remarks: remarks,
            dispatchTime: new Date().toISOString()
          }

          // å­˜å‚¨åˆ†æ´¾ä¿¡æ¯åˆ° sessionStorageï¼ˆæ¨¡æ‹Ÿï¼‰
          sessionStorage.setItem(
            `dispatch_${taskNumber}`,
            JSON.stringify(dispatchInfo)
          )

          // æ›´æ–°ä»»åŠ¡çŠ¶æ€
          taskStatus = 'assigned'

          // æ›´æ–°URL
          const newUrl = `${window.location.pathname}?task=${taskNumber}&status=assigned`
          window.history.pushState({}, '', newUrl)

          // é‡æ–°æ¸²æŸ“é¡µé¢
          updateTaskInfo()
          updateStatusDisplay()
          updatePageActions()
          renderDynamicContent()

          // æ¸…é™¤æœªä¿å­˜æ›´æ”¹æ ‡è®°
          clearUnsavedChanges()
          selectedStaff.clear()

          alert('ä»»åŠ¡åˆ†æ´¾æˆåŠŸï¼ç³»ç»Ÿå·²é€šçŸ¥ç›¸å…³æ£€æµ‹äººå‘˜ã€‚')
        }
      }

      // æ»šåŠ¨åˆ°åˆ†æ´¾åŒºåŸŸ
      function scrollToAssignment() {
        const dynamicContent = document.getElementById('dynamic-content')
        dynamicContent.scrollIntoView({ behavior: 'smooth' })
      }

      // é‡æ–°åˆ†æ´¾
      function reassignTask() {
        if (confirm('ç¡®å®šè¦é‡æ–°åˆ†æ´¾æ­¤ä»»åŠ¡å—ï¼Ÿè¿™å°†æ¸…é™¤å½“å‰çš„åˆ†æ´¾ä¿¡æ¯ã€‚')) {
          // æ›´æ–°ä»»åŠ¡çŠ¶æ€
          taskStatus = 'pending'

          // æ›´æ–°URL
          const newUrl = `${window.location.pathname}?task=${taskNumber}&status=pending`
          window.history.pushState({}, '', newUrl)

          // é‡æ–°æ¸²æŸ“é¡µé¢
          updateTaskInfo()
          updateStatusDisplay()
          updatePageActions()
          renderDynamicContent()

          alert('å·²åˆ‡æ¢ä¸ºé‡æ–°åˆ†æ´¾æ¨¡å¼ï¼Œè¯·é‡æ–°è®¾ç½®åˆ†æ´¾ä¿¡æ¯ã€‚')
        }
      }

      // å¯¼å‡ºä»»åŠ¡ä¿¡æ¯
      function exportTaskInfo() {
        alert(`æ­£åœ¨å¯¼å‡ºä»»åŠ¡ ${taskNumber} çš„è¯¦ç»†ä¿¡æ¯...`)
      }

      // æŸ¥çœ‹æ£€æµ‹æŠ¥å‘Š
      function viewTestReport() {
        alert(`æ­£åœ¨æ‰“å¼€ä»»åŠ¡ ${taskNumber} çš„æ£€æµ‹æŠ¥å‘Š...`)
      }

      // ä¸‹è½½æ£€æµ‹æ•°æ®
      function downloadData() {
        alert(`æ­£åœ¨ä¸‹è½½ä»»åŠ¡ ${taskNumber} çš„æ£€æµ‹æ•°æ®...`)
      }

      // æŸ¥çœ‹æ£€æµ‹è¯ä¹¦
      function viewCertificate() {
        alert(`æ­£åœ¨æ‰“å¼€ä»»åŠ¡ ${taskNumber} çš„æ£€æµ‹è¯ä¹¦...`)
      }

      // æ›´æ–°çš„å¼€å§‹æ£€æµ‹å’Œç»“æŸæ£€æµ‹å‡½æ•°

      // å¼€å§‹æ£€æµ‹ï¼ˆæ›´æ–°ç‰ˆæœ¬ï¼‰
      function startTesting() {
        if (confirm('ç¡®å®šå¼€å§‹æ£€æµ‹å—ï¼Ÿå¼€å§‹åå°†è®°å½•æ£€æµ‹å¼€å§‹æ—¶é—´ã€‚')) {
          // æ›´æ–°ä»»åŠ¡çŠ¶æ€
          taskStatus = 'processing'

          // æ›´æ–°URL
          const newUrl = `${window.location.pathname}?task=${taskNumber}&status=processing`
          window.history.pushState({}, '', newUrl)

          // é‡æ–°æ¸²æŸ“é¡µé¢
          updateTaskInfo()
          updateStatusDisplay()
          updatePageActions()
          renderDynamicContent()

          // æ¸…é™¤æœªä¿å­˜æ›´æ”¹æ ‡è®°
          clearUnsavedChanges()

          alert('æ£€æµ‹å·²å¼€å§‹ï¼è¯·æŒ‰ç…§æ£€æµ‹æ ‡å‡†è¿›è¡Œæ“ä½œã€‚')
        }
      }

      // ç»“æŸæ£€æµ‹ï¼ˆæ›´æ–°ç‰ˆæœ¬ï¼‰
      function endTesting() {
        if (
          confirm(
            'ç¡®å®šç»“æŸæ£€æµ‹å—ï¼Ÿç»“æŸåå°†è®°å½•æ£€æµ‹ç»“æŸæ—¶é—´ï¼Œä»»åŠ¡å°†è¿›å…¥å®ŒæˆçŠ¶æ€ã€‚'
          )
        ) {
          // æ›´æ–°ä»»åŠ¡çŠ¶æ€
          taskStatus = 'completed'

          // æ›´æ–°URL
          const newUrl = `${window.location.pathname}?task=${taskNumber}&status=completed`
          window.history.pushState({}, '', newUrl)

          // é‡æ–°æ¸²æŸ“é¡µé¢
          updateTaskInfo()
          updateStatusDisplay()
          updatePageActions()
          renderDynamicContent()

          // æ¸…é™¤æœªä¿å­˜æ›´æ”¹æ ‡è®°
          clearUnsavedChanges()

          alert('æ£€æµ‹ä»»åŠ¡å·²å®Œæˆï¼ç³»ç»Ÿå°†è‡ªåŠ¨é€šçŸ¥æŠ¥å‘Šç¼–åˆ¶äººå‘˜ç”Ÿæˆæ£€æµ‹æŠ¥å‘Šã€‚')
        }
      }

      // æ ‡è®°æ•°æ®å˜æ›´
      function markAsChanged(field, oldValue, newValue) {
        if (oldValue !== newValue) {
          hasUnsavedChanges = true
          originalData[field] = oldValue
        }
      }

      // æ¸…é™¤æœªä¿å­˜æ›´æ”¹æ ‡è®°
      function clearUnsavedChanges() {
        hasUnsavedChanges = false
        originalData = {}
      }

      // æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„æ›´æ”¹
      function checkUnsavedChanges() {
        return hasUnsavedChanges
      }

      // åˆ›å»ºå¤‡ç”¨å¯¼èˆªæŒ‰é’®ï¼ˆå½“ä¸»å¯¼èˆªå¤±è´¥æ—¶æ˜¾ç¤ºï¼‰
      function createFallbackNavigation() {
        const fallbackNav = document.createElement('div')
        fallbackNav.id = 'fallback-navigation'
        fallbackNav.innerHTML = `
                <div style="position: fixed; top: 10px; right: 10px; z-index: 9999; background: #ef4444; color: white; padding: 10px; border-radius: 6px; font-size: 14px;">
                    <span>å¯¼èˆªå‡ºé”™ï¼Œè¯·ä½¿ç”¨ï¼š</span>
                    <button onclick="location.href='lab-dashboard.html'" style="margin-left: 8px; padding: 4px 8px; background: white; color: #ef4444; border: none; border-radius: 4px; cursor: pointer;">è¿”å›å·¥ä½œå°</button>
                    <button onclick="this.parentElement.parentElement.remove()" style="margin-left: 4px; background: transparent; color: white; border: 1px solid white; padding: 2px 6px; border-radius: 4px; cursor: pointer;">Ã—</button>
                </div>
            `
        document.body.appendChild(fallbackNav)

        // 10ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => {
          if (document.getElementById('fallback-navigation')) {
            document.getElementById('fallback-navigation').remove()
          }
        }, 10000)
      }

      // é¡µé¢åŠ è½½åŠ¨ç”»
      window.addEventListener('load', function () {
        const cards = document.querySelectorAll('.info-card, .status-card')
        cards.forEach((card, index) => {
          card.style.opacity = '0'
          card.style.transform = 'translateY(20px)'
          setTimeout(() => {
            card.style.transition = 'all 0.3s ease'
            card.style.opacity = '1'
            card.style.transform = 'translateY(0)'
          }, index * 100)
        })
      })

      // ç›‘å¬é¡µé¢é”™è¯¯ï¼Œå¦‚å¯¼èˆªå¤±è´¥
      window.addEventListener('error', function (e) {
        if (e.message && e.message.includes('navigation')) {
          console.error('å¯¼èˆªé”™è¯¯ï¼š', e)
          createFallbackNavigation()
        }
      })

      // å…¨å±€å˜é‡
      let selectedStaff = new Set()

      // æ£€æµ‹äººå‘˜æ•°æ®
      const staffList = [
        { id: 1, name: 'ç‹å…«', status: 'ç©ºé—²', tasks: 2 },
        { id: 2, name: 'å­™ä¹', status: 'å·¥ä½œä¸­', tasks: 3 },
        { id: 3, name: 'å‘¨å', status: 'ç©ºé—²', tasks: 1 },
        { id: 4, name: 'æå››', status: 'ç©ºé—²', tasks: 0 },
        { id: 5, name: 'å¼ ä¸‰', status: 'å·¥ä½œä¸­', tasks: 4 }
      ]

      // åˆå§‹åŒ–äººå‘˜é€‰æ‹©ï¼ˆæ–°ç‰ˆæœ¬ï¼Œå‚è€ƒsampling-dispatch-detail.htmlï¼‰
      function initializeStaffSelect() {
        console.log('initializeStaffSelect - å¼€å§‹åˆå§‹åŒ–')
        const container = document.getElementById('staffSelectContainer')
        if (!container) {
          console.log('initializeStaffSelect - å®¹å™¨ä¸å­˜åœ¨')
          return
        }

        console.log('initializeStaffSelect - å®¹å™¨å­˜åœ¨ï¼Œç”Ÿæˆäººå‘˜é€‰é¡¹')
        container.innerHTML = staffList
          .map(
            staff => `
                <div class="staff-option" data-id="${staff.id}" onclick="toggleStaff(${staff.id})">
                    <input type="checkbox" class="staff-checkbox-new" id="staff-${staff.id}" 
                           onchange="event.stopPropagation(); toggleStaff(${staff.id})">
                    <label for="staff-${staff.id}" class="staff-info-new" onclick="event.preventDefault()">
                        <div class="staff-name-new">${staff.name}</div>
                        <div class="staff-status-new">çŠ¶æ€: ${staff.status}</div>
                    </label>
                    <div class="staff-tasks">ä»Šæ—¥${staff.tasks}ä¸ªä»»åŠ¡</div>
                </div>
            `
          )
          .join('')

        console.log('initializeStaffSelect - äººå‘˜é€‰é¡¹ç”Ÿæˆå®Œæˆ')
      }

      // åˆ‡æ¢äººå‘˜é€‰æ‹©ï¼ˆæ–°ç‰ˆæœ¬ï¼‰
      function toggleStaff(id) {
        const option = document.querySelector(`.staff-option[data-id="${id}"]`)
        const checkbox = document.getElementById(`staff-${id}`)

        if (!option || !checkbox) return

        // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
        checkbox.checked = !checkbox.checked

        if (checkbox.checked) {
          selectedStaff.add(id)
          option.classList.add('selected')
        } else {
          selectedStaff.delete(id)
          option.classList.remove('selected')
        }

        // æ ‡è®°æœ‰å˜æ›´
        hasUnsavedChanges = true
      }
    </script>
  </body>
</html>
